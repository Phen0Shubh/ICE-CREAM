<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document Verification System</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="contract.js"></script>
</head>
<body>
<div class="container">

  <div class="card">
    <h2>Blockchain Document Verification</h2>
    <button id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
    <p id="walletInfo"></p>
    <p id="roleInfo"></p>
    <button id="logoutBtn" style="display:none;" onclick="logoutWallet()">Logout</button>
  </div>

  <!-- Issuer Panel -->
  <div class="card" id="issuerPanel" style="display:none;">
    <h2>Issuer Dashboard</h2>
    <input type="text" id="holderName" placeholder="Holder Full Name">
    <input type="text" id="enrollNo" placeholder="Enrollment Number">
    <input type="text" id="holderAddr" placeholder="Holder Address (0x...)">
    <input type="text" id="docTitle" placeholder="Document Title">
    <input type="file" id="fileInputIss">
    <button onclick="registerDocument()">Register Document</button>
    <p id="issuerOutput"></p>
  </div>

  <!-- Holder Panel -->
  <div class="card" id="holderPanel" style="display:none;">
    <h2>Holder Dashboard</h2>
    <div id="holderOutput">Loading...</div>
  </div>

</div>

<script>
let provider, signer, contract, userAddress;

async function connectWallet() {
  if (!window.ethereum) return alert("Install MetaMask!");
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  userAddress = (await signer.getAddress()).toLowerCase();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
  document.getElementById("walletInfo").innerText = "Connected: " + userAddress;
  determineRole();
  document.getElementById("connectBtn").style.display = "none";
  document.getElementById("logoutBtn").style.display = "inline-block";
}

function logoutWallet() {
  provider = signer = contract = userAddress = null;
  document.getElementById("walletInfo").innerText = "";
  document.getElementById("roleInfo").innerText = "";
  document.getElementById("issuerPanel").style.display = "none";
  document.getElementById("holderPanel").style.display = "none";
  document.getElementById("connectBtn").style.display = "inline-block";
  document.getElementById("logoutBtn").style.display = "none";
}

async function determineRole() {
  try {
    const isIssuer = await contract.issuers(userAddress);
    const docs = await contract.getDocsByHolder(userAddress).catch(()=>[]);
    if (isIssuer) {
      document.getElementById("roleInfo").innerText = "Role: Issuer";
      document.getElementById("issuerPanel").style.display = "block";
    } else if (docs.length > 0) {
      document.getElementById("roleInfo").innerText = "Role: Holder";
      document.getElementById("holderPanel").style.display = "block";
      loadHolderDocs();
    } else {
      document.getElementById("roleInfo").innerText = "Role: No Issuer/Hold docs found";
    }
  } catch (e) {
    console.error(e);
    alert("Error determining role");
  }
}

async function registerDocument() {
  const holder = document.getElementById("holderAddr").value.trim();
  const title = document.getElementById("docTitle").value.trim();
  const holderName = document.getElementById("holderName").value.trim();
  const enrollNo = document.getElementById("enrollNo").value.trim();
  const file = document.getElementById("fileInputIss").files[0];

  if (!ethers.utils.isAddress(holder)) return alert("Invalid holder address");
  if (!title || !holderName || !enrollNo || !file) return alert("Fill all fields");

  const hash = await fileHash(file);
  const PINATA_JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiJjM2Q0OTk0Yy0yNTM1LTQ1NDUtYmYxYy0zOTI5MmUwNjM3ODAiLCJlbWFpbCI6ImNoYXVoYW5zaHViaDQ1QGdtYWlsLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwaW5fcG9saWN5Ijp7InJlZ2lvbnMiOlt7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6IkZSQTEifSx7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6Ik5ZQzEifV0sInZlcnNpb24iOjF9LCJtZmFfZW5hYmxlZCI6ZmFsc2UsInN0YXR1cyI6IkFDVElWRSJ9LCJhdXRoZW50aWNhdGlvblR5cGUiOiJzY29wZWRLZXkiLCJzY29wZWRLZXlLZXkiOiI2NmI5ZWIwZGMxM2JlODI5ZGE5YyIsInNjb3BlZEtleVNlY3JldCI6IjIwMGFlZTY5Njc5ODBlNmYzNTA5M2JmYjRjYjY1MjMzZDVmZTY3YjI2YTIxMTljYjgyNzczNjk2ZTBiMjM4ZDYiLCJleHAiOjE3OTAxNzAyODR9.XcQ7DLm6SJL7-LTlCK7USQX7mP5UaAOUW5p7K_jJKGo
";
  const ipfsCid = await uploadToPinata(file, PINATA_JWT);

  const signerContract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
  const tx = await signerContract.registerDocument(hash, holder, title, holderName, enrollNo, ipfsCid);
  await tx.wait();

  document.getElementById("issuerOutput").innerText =
    `âœ… Registered!\nHolder: ${holderName} (${enrollNo})\nHash: ${hash}\nIPFS: https://gateway.pinata.cloud/ipfs/${ipfsCid}`;
}

async function loadHolderDocs() {
  const hashes = await contract.getDocsByHolder(userAddress);
  if (!hashes.length) {
    document.getElementById("holderOutput").innerText = "No documents found.";
    return;
  }

  let html = "<table><tr><th>Title</th><th>Holder</th><th>Enroll No</th><th>Issuer</th><th>IPFS</th><th>Issued On</th><th>Status</th></tr>";
  for (let h of hashes) {
    const d = await contract.getDocument(h);
    html += `<tr>
      <td>${d[2]}</td>
      <td>${d[3]}</td>
      <td>${d[4]}</td>
      <td>${d[0]}</td>
      <td><a href="https://gateway.pinata.cloud/ipfs/${d[5]}" target="_blank">View</a></td>
      <td>${new Date(d[6] * 1000).toLocaleString()}</td>
      <td>${d[7] ? "Revoked" : "Active"}</td>
    </tr>`;
  }
  html += "</table>";
  document.getElementById("holderOutput").innerHTML = html;
}
</script>
</body>
</html>

